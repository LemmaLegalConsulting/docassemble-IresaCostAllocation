metadata:
  title: Child and Youth Welfare Cost Allocation & Assessment
  short title: Welfare Cost Assessment (Kostenheranziehung)
  comment: A comprehensive system to determine benefit eligibility, contribution obligations, and income assessments for child and youth welfare services.
  authors:
    - Jim Graszer
    - Rami Lorca
---
include:
  - docassemble.AssemblyLine:assembly_line.yml
---
modules:
  - .contributions
  - docassemble.base.util
  - docassemble.base.functions
---
initial: True
code: |
  set_language('de')
  set_locale('DE.utf8')
  set_locale(currency_symbol='€')
  update_locale()
---
objects:
  - users: ALPeopleList.using(there_are_any=True, complete_attribute="complete", target_number=1)
  - recipient: ALPeopleList.using(complete_attribute="complete")
  - costs_file: DAStaticFile.using(filename='data/sources/income_cost.csv')
---
sections:
  - section_intro: Welcome
  - section_recipient: Recipient
  - section_summary: Summary
---
#################### Interview Order Start #####################
---
mandatory: True
code: |
  nav.set_section('section_intro')
  
  welcome

  set_progress(5)

  users.gather()

  if users[0].role == "parent":
    set_recipient

    if recipient.there_are_any:
      recipient.gather()

  benefit

  benefits_kickout

  if users[0].pregnant:
    placeholder_ending 

  if users[0].role == "parent":
    users[0].lives_with_recipient

    if not users[0].lives_with_recipient: 
      if benefit_type == "partial_time":
        placeholder_ending 

  monthly_cost

  cash_benefit

  if users[0].role == "recipient":
    placeholder_ending 
  else:
    users[0].monthly_income
    other_recipients_same_benefit
    impacted_maint_rights
    placeholder_ending 

  nav.set_section('section_summary')
  
  placeholder_ending 

  set_progress(100)
---
#################### Other Blocks Start #####################
---
code: |
  users[i].name.first
  users[i].role
  if users[i].role == "recipient":
    users[i].birthdate

  users[i].complete = True
---
code: |
  if users[0].role == "recipient":
    if users[0].age_in_years() < 18:
      if benefit_type == "full_time":
        placeholder_ending 
    else:
      if benefit != "1" and benefit != "4" and benefit != "8":
        placeholder_ending 

  benefits_kickout = True
---
code: |
  recipient[i].name.first
  recipient[i].birthdate

  recipient[i].complete = True
---
code: |
  recipient.there_is_another = False
---
code: |
  if users[0].role == "parent":
    recipient.there_are_any = True
  else:
    recipient.there_are_any = False

  set_recipient = True
---
#################### Question Blocks Start #####################
---
id: welcome
question: |
  Child and Youth Welfare Cost Allocation & Assessment
subquestion: |
  Welfare Cost Assessment (Kostenheranziehung)
continue button field: welcome
---
id: contributor information
sets:
  - users[0].name.first
  - users[0].name.last
  - users[0].role
  - users[0].birthdate
question: |
  About the contributor
subquestion: |
  Tell us about the person that will be potentially contributing to the cost of this benefit. 
fields:
  - code: |
      users[0].name_fields()
  - This person is...: users[0].role
    datatype: radio
    choices:
      - A parent or guardian of the person receiving the benefit: parent
      - The person receiving the benefit: recipient
  - When was the recipient born?: users[0].birthdate
    datatype: BirthDate 
    show if:
      variable: users[0].role
      is: "recipient"
---
id: select benefit 
question: |
  Benefit selection
fields: 
  - Which benefit will ${ users[0].name } be contributing to?: benefit
    datatype: radio
    choices:
      - Housing for young people in residential settings: 1
      - Housing for parents with children in residential settings: 2
      - Care/support in emergency residential situations: 3
      - Placement for attending or completing school: 4
      - Help with upbringing (full-time foster care, children's homes, etc.): 5
      - Integration support for children/youth with disabilities: 6
      - Temporary protective custody (Inobhutnahme): 7
      - Support for young adults (similar to residential services): 8
      - Day/partial-time care in emergency or regular settings: 9
      - Upbringing support in day groups or partial facilities: 10
      - Integration support in day facilities: 11
      - Support for young adults (if related to residential services): 12
validation code: |
  if benefit == "9" or \
  benefit == "10" or \
  benefit == "11" or \
  benefit == "12":
    benefit_type == "partial_time"
  else:
    benefit_type == "full_time"
---
id: monthly cost
question: |
  Actual monthly cost of the service
fields:
  - Cost: monthly_cost
    datatype: currency
---
id: recipient
sets:
  - recipient[i].name.first
  - recipient[i].name.last
  - recipient[i].birthdate
question: |
  Who will be the benefit recipient?
fields: 
  - code: |
      recipient[0].name_fields()
  - When was the recipient born?: recipient[0].birthdate
    datatype: BirthDate 
---
id: recipient has children 
question: |
  Pregnancy or caring for child under 6
fields: 
  - Is the contributor pregnant or caring for a child under 6?: users[0].pregnant
    datatype: yesnoradio
---
id: does parent live with recipient
question: |
  Living with recipient
fields:
  - Does ${ users[0] } live with ${ recipient[0] }?: users[0].lives_with_recipient
    datatype: yesnoradio
---
id: recipient cash benefit
question: |
  Does the recipient get cash benefits that serve the same purpose as the respective youth welfare benefit?
fields:
  - no label: cash_benefit
    datatype: yesnoradio 
---
id: monthly income 
question: |
  What is ${ users[0] }'s adjusted average monthly income?
fields: 
  - Monthly income: users[0].monthly_income
    datatype: currency
---
id: other recipients with same benefit
question: |
  Other benefit recipients
fields: 
  - Is ${ users[0] } responsible for other dependents receiving the **same** benefit?: other_recipients_same_benefit
    datatype: yesnoradio
  - How many of those dependents started receiving this benefit **before** ${ recipient[0] }?: prior_recipients_num
    datatype: integer
    min: 0
    show if:
      variable: other_recipients_same_benefit
      is: True
---
id: impacted maintenance rights
question: |
  Impacted maintenance rights
fields:
  - Will the maintenance rights of any dependents be impacted if ${ users[0] } contributes to the current benefit?: impacted_maint_rights
    datatype: yesnoradio
  - How many others' maintenance rights would be impacted?: impacted_maint_rights_num
    datatype: integer
    min: 1
    show if:
      variable: impacted_maint_rights
      is: True
---
code: |
  deductions = tax_deduction + ss_contribution + other_contributions
  adjusted_income = (monthly_income - deductions)
  cost_share = adjusted_income * 0.25
  additional_cost = (insurance + expenses + debt)

  income_group = adjusted_income - additional_cost

  # Use the income and child to determine cost contribution returning up to 3 levels:
  result_cost = calculate_cost(costs_file.path(), income_group, child_position)

  estimate_cost = True
---
id: summary
event: summary
question: |
  Summary of your responses:
subquestion: |
  - Benefits applicable: ${ benefits.any_true() }
  - contributor: ${ 'Parent' if 'Parent' in users[0].contributor else '' } ${ 'Child' if 'Child or adolescent' in users[0].contributor else '' } ${ 'Young adult' if 'Young adult' in users[0].contributor else '' }
  - Monthly income: € ${ monthly_income }
  - Adjusted income: € ${ adjusted_income }
  - Cost contribution: € ${ cost_share }
  - Additional reduction: € ${ additional_cost }
  - Income level: € ${ adjusted_income - additional_cost }

  
  **Results** € ${ result_cost }

buttons:
- Exit: exit
- Restart: restart
---
id: placeholder interview end
event: placeholder_ending 
question: |
  This is a temporary placeholder ending. 
subquestion: |
  In the finalized interview, this screen will display the cost-sharing summary.
---
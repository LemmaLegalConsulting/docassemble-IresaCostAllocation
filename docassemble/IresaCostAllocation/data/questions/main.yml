metadata:
  title: Child and Youth Welfare Cost Allocation & Assessment
  short title: Welfare Cost Assessment (Kostenheranziehung)
  comment: A comprehensive system to determine benefit eligibility, contribution obligations, and income assessments for child and youth welfare services.
  authors:
    - Jim Graszer
    - Rami Lorca
---
include:
  - docassemble.AssemblyLine:assembly_line.yml
---
modules:
  - .contributions
  - docassemble.base.util
  - docassemble.base.functions
---
initial: True
code: |
  set_language('de')
  set_locale('DE.utf8')
  set_locale(currency_symbol='€')
  update_locale()

  CHILD_BENEFIT = 255

  CHILD_BENEFIT = 255
---
objects:
  - users: ALPeopleList.using(there_are_any=True, complete_attribute="complete", target_number=1)
  - recipient: ALPeopleList.using(complete_attribute="complete")
  - costs_file: DAStaticFile.using(filename='data/sources/income_cost.csv')
---
sections:
  - section_intro: Welcome
  - section_recipient: Recipient
  - section_summary: Summary
---
#################### Interview Order Start #####################
---
mandatory: True
code: |
  nav.set_section('section_intro')

  welcome

  set_progress(5)

  users.gather()

  if users[0].role == "parent":
    set_recipient

    if recipient.there_are_any:
      recipient.gather()

  service_category

  benefits_kickout

  if users[0].pregnant:
    placeholder_ending 

  if users[0].role == "parent":
    users[0].lives_with_recipient

    if not users[0].lives_with_recipient: 
      if service_type == "partial_time":
        placeholder_ending 

  monthly_cost

  child_benefit

  cash_benefit

  if users[0].role == "recipient":
    placeholder_ending 
  else:
    users[0].monthly_income
    other_recipients_same_benefit
    impacted_maint_rights
    placeholder_ending 

  nav.set_section('section_summary')

  placeholder_ending 

  set_progress(100)
---
#################### Other Blocks Start #####################
---
code: |
  users[i].name.first
  users[i].role
  if users[i].role == "recipient":
    users[i].birthdate

  users[i].complete = True
---
code: |
  users.there_is_another = False
---
code: |
  if users[0].role == "recipient":
    if users[0].age_in_years() < 18:
      if service_type == "full_time":
        placeholder_ending 
    else:
      if benefit != "service_1_1" and benefit != "service_1_4" and benefit != "service_1_8":
        placeholder_ending 

  benefits_kickout = True
---
code: |
  recipient[i].name.first
  recipient[i].birthdate

  recipient[i].complete = True
---
code: |
  recipient.there_is_another = False
---
code: |
  if users[0].role == "parent":
    recipient.there_are_any = True
  else:
    recipient.there_are_any = False

  set_recipient = True
---
#################### Question Blocks Start #####################
---
id: welcome
question: |
  Child and Youth Welfare Cost Allocation & Assessment
subquestion: |
  Welfare Cost Assessment (Kostenheranziehung)
continue button field: welcome
---
id: contributor information
sets:
  - users[0].name.first
  - users[0].name.last
  - users[0].role
  - users[0].birthdate
question: |
  About the contributor
subquestion: |
  Tell us about the person that will be potentially contributing to the cost of this benefit.
fields:
  - code: |
      users[0].name_fields()
  - This person is...: users[0].role
    datatype: radio
    choices:
      - A parent or guardian of the person receiving the benefit: parent
      - The person receiving the benefit: recipient
  - When was the recipient born?: users[0].birthdate
    datatype: BirthDate
    show if:
      variable: users[0].role
      is: "recipient"
---
id: service_selection
question: |
  Which service does the recipient require?
fields:
  - no label: service_category
    datatype: radio
    choices:
      code: |
        service_labels
validation code: |
  if service_category == "service_2_1" or \
  service_category == "service_2_2" or \
  service_category == "service_2_3" or \
  service_category == "service_2_4":
    service_type = "partial_time"
  else:
    service_type = "full_time"
---
template: service_1_1_template
content: Housing for young people in residential (Section 13 (3))
---
template: service_1_2_template
content: Housing for parents with children in shared residential arrangements (Section 19)
---
template: service_1_3_template
content: Emergency care/support for children and adolescents (Section 20)
---
template: service_1_4_template
content: Placement support for children and adolescents to attend or finish school (Section 21)
---
template: service_1_5_template
content: Assistance with upbringing (full-time foster care, children's homes}, etc.) (Section 92)
---
template: service_1_6_template
content: Integration support for children and adolescents with disabilities (Section 35a (2) Nos. 3-4)
---
template: service_1_7_template
content: Temporary custody/support for children (Section 42)
---
template: service_1_8_template
content: Support for young adults, similar to residential services (Section 41)
---
template: service_2_1_template
content: Day and partial-time care in emergency or regular settings (Section 91 (2) Nos. 1-4)
---
template: service_2_2_template
content: Upbringing support in day-care groups and partial facilities (Section 92 (1a) No. 4)
---
template: service_2_3_template
content: Integration support in day-care facilities (Section 92 (1a) No. 4, Nos. 2-3)
---
template: service_2_4_template
content: Support for young adults related to residential or care services (Section 41)
---
code: |
  service_labels = [
    {'service_1_1': str(service_1_1_template)},
    {'service_1_2': str(service_1_2_template)},
    {'service_1_3': str(service_1_3_template)},
    {'service_1_4': str(service_1_4_template)},
    {'service_1_5': str(service_1_5_template)},
    {'service_1_6': str(service_1_6_template)},
    {'service_1_7': str(service_1_7_template)},
    {'service_1_8': str(service_1_8_template)},
    {'service_2_1': str(service_2_1_template)},
    {'service_2_2': str(service_2_2_template)},
    {'service_2_3': str(service_2_3_template)},
    {'service_2_4': str(service_2_4_template)}
  ]
---
id: monthly cost
question: |
  Actual monthly cost of the service
fields:
  - Cost: monthly_cost
    datatype: currency
---
id: recipient child/youth benefits
question: |
  Child/youth benefits
fields:
  - Does the recipient receive child/youth benefits?: child_benefit
    datatype: yesnoradio
---
id: recipient
sets:
  - recipient[i].name.first
  - recipient[i].name.last
  - recipient[i].birthdate
question: |
  Who will be the benefit recipient?
fields:
  - code: |
      recipient[0].name_fields()
  - When was the recipient born?: recipient[0].birthdate
    datatype: BirthDate
---
id: recipient has children
question: |
  Pregnancy or caring for child under 6
fields:
  - Is the contributor pregnant or caring for a child under 6?: users[0].pregnant
    datatype: yesnoradio
---
id: does parent live with recipient
question: |
  Living with recipient
fields:
  - Does ${ users[0] } live with ${ recipient[0] }?: users[0].lives_with_recipient
    datatype: yesnoradio
---
id: recipient cash benefits
question: |
  Does the recipient get cash benefits that serve the same purpose as the respective youth welfare benefit?
fields:
  - no label: cash_benefit
    datatype: yesnoradio
---
id: monthly income
question: |
  What is ${ users[0] }'s adjusted average monthly income?
fields:
  - Monthly income: users[0].monthly_income
    datatype: currency
---
id: other recipients with same benefit
question: |
  Other benefit recipients
fields:
  - Is ${ users[0] } responsible for other dependents receiving the **same** benefit?: other_recipients_same_benefit
    datatype: yesnoradio
  - How many of those dependents started receiving this benefit **before** ${ recipient[0] }?: prior_recipients_num
    datatype: integer
    min: 0
    show if:
      variable: other_recipients_same_benefit
      is: True
---
id: impacted maintenance rights
question: |
  Impacted maintenance rights
fields:
  - Will the maintenance rights of any dependents be impacted if ${ users[0] } contributes to the current benefit?: impacted_maint_rights
    datatype: yesnoradio
  - How many others' maintenance rights would be impacted?: impacted_maint_rights_num
    datatype: integer
    min: 1
    show if:
      variable: impacted_maint_rights
      is: True
---
code: |
  deductions = tax_deduction + ss_contribution + other_contributions
  adjusted_income = (monthly_income - deductions)
  cost_share = adjusted_income * 0.25
  additional_cost = (insurance + expenses + debt)

  income_group = adjusted_income - additional_cost

  # Use the income and child to determine cost contribution returning up to 3 levels:
  result_cost = calculate_cost(costs_file.path(), income_group, child_position)

  estimate_cost = True
---
# This is a debugging screen and won't be used later
id: summary
event: summary
question: |
  Summary of your responses:
subquestion: |
  - Service: ${ service_category }
  - contributor: ${ 'Parent' if 'Parent' in users[0].contributor else '' } ${ 'Child' if 'Child or adolescent' in users[0].contributor else '' } ${ 'Young adult' if 'Young adult' in users[0].contributor else '' }
  - Monthly income: € ${ monthly_income }
  - Adjusted income: € ${ adjusted_income }
  - Cost contribution: € ${ cost_share }
  - Additional reduction: € ${ additional_cost }
  - Income level: € ${ adjusted_income - additional_cost }


  **Results** € ${ result_cost }

buttons:
  - Exit: exit
  - Restart: restart
---
id: placeholder interview end
event: placeholder_ending
question: |
  This is a temporary placeholder ending.
subquestion: |
  In the finalized interview, this screen will display the cost-sharing summary.
---